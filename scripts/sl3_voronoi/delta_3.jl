include(joinpath(@__DIR__, "voronoi_utils.jl"));

S_m2, S_m31, S_m32 = saturate(S,m2_stab), saturate(S,m31_stab), saturate(S,m32_stab);
S_sat = collect(union(S_m2,S_m31,S_m32,m2_stab,m31_stab,m32_stab));
S_sat_inv = collect(Set([S_sat; inv.(S_sat)]));
ball2_sat, sizes_sat = Groups.wlmetric_ball(S_sat_inv, radius = 2);
outsiders_d4₁₁ = [gelt_from_matrix(M,ball8) for M in [
    [-1 0 0; 1 0 1; 1 1 0],[0 0 1; -1 0 -1; -1 -1 0],
    [-1 0 -1; 1 0 0; -1 -1 0],[1 0 1; 0 0 -1; 1 1 0]
]]
# half_basis_sat = collect(union(ball2_sat,outsiders_d4₁₁))
temp_basis = collect(union(ball2_sat, outsiders_d4₁₁))

d311_array = [
    [0 1 0; 0 0 1; 1 1 0], [0 -1 0; 0 0 -1; 1 1 0], [0 -1 0; 0 0 1; -1 -1 0], 
    [0 1 0; 0 0 -1; -1 -1 0], [0 -1 0; 1 1 0; 0 0 1], [0 1 0; -1 -1 0; 0 0 1], 
    [0 1 0; 1 1 0; 0 0 -1], [0 -1 0; -1 -1 0; 0 0 -1], [0 0 -1; 0 1 0; 1 1 0], 
    [0 0 1; 0 -1 0; 1 1 0], [0 0 1; 0 1 0; -1 -1 0], [0 0 -1; 0 -1 0; -1 -1 0], 
    [0 0 1; 1 1 0; 0 1 0], [0 0 -1; -1 -1 0; 0 1 0], [0 0 -1; 1 1 0; 0 -1 0], 
    [0 0 1; -1 -1 0; 0 -1 0], [1 1 0; 0 1 0; 0 0 1], [-1 -1 0; 0 -1 0; 0 0 1], 
    [-1 -1 0; 0 1 0; 0 0 -1], [1 1 0; 0 -1 0; 0 0 -1], [-1 -1 0; 0 0 1; 0 1 0], 
    [1 1 0; 0 0 -1; 0 1 0], [1 1 0; 0 0 1; 0 -1 0], [-1 -1 0; 0 0 -1; 0 -1 0]
]
d312_array = [
    [-1 0 0; 0 0 1; 1 1 0], [1 0 0; 0 0 -1; 1 1 0], [1 0 0; 0 0 1; -1 -1 0], 
    [-1 0 0; 0 0 -1; -1 -1 0], [1 0 0; 1 1 0; 0 0 1], [-1 0 0; -1 -1 0; 0 0 1], 
    [-1 0 0; 1 1 0; 0 0 -1], [1 0 0; -1 -1 0; 0 0 -1], [0 0 1; 1 0 0; 1 1 0], 
    [0 0 -1; -1 0 0; 1 1 0], [0 0 -1; 1 0 0; -1 -1 0], [0 0 1; -1 0 0; -1 -1 0], 
    [0 0 -1; 1 1 0; 1 0 0], [0 0 1; -1 -1 0; 1 0 0], [0 0 1; 1 1 0; -1 0 0], 
    [0 0 -1; -1 -1 0; -1 0 0], [-1 -1 0; 1 0 0; 0 0 1], [1 1 0; -1 0 0; 0 0 1], 
    [1 1 0; 1 0 0; 0 0 -1], [-1 -1 0; -1 0 0; 0 0 -1], [1 1 0; 0 0 1; 1 0 0], 
    [-1 -1 0; 0 0 -1; 1 0 0], [-1 -1 0; 0 0 1; -1 0 0], [1 1 0; 0 0 -1; -1 0 0]
]
d313_array = [
    [1 0 0; 0 1 0; 0 0 1], [-1 0 0; 0 -1 0; 0 0 1], [-1 0 0; 0 1 0; 0 0 -1], 
    [1 0 0; 0 -1 0; 0 0 -1], [-1 0 0; 0 0 1; 0 1 0], [1 0 0; 0 0 -1; 0 1 0], 
    [1 0 0; 0 0 1; 0 -1 0], [-1 0 0; 0 0 -1; 0 -1 0], [0 -1 0; 1 0 0; 0 0 1], 
    [0 1 0; -1 0 0; 0 0 1], [0 1 0; 1 0 0; 0 0 -1], [0 -1 0; -1 0 0; 0 0 -1], 
    [0 1 0; 0 0 1; 1 0 0], [0 -1 0; 0 0 -1; 1 0 0], [0 -1 0; 0 0 1; -1 0 0], 
    [0 1 0; 0 0 -1; -1 0 0], [0 0 1; 1 0 0; 0 1 0], [0 0 -1; -1 0 0; 0 1 0], 
    [0 0 -1; 1 0 0; 0 -1 0], [0 0 1; -1 0 0; 0 -1 0], [0 0 -1; 0 1 0; 1 0 0], 
    [0 0 1; 0 -1 0; 1 0 0], [0 0 1; 0 1 0; -1 0 0], [0 0 -1; 0 -1 0; -1 0 0]
]
d321_array = [
    [0 1 0; 0 0 1; 1 1 1], [0 -1 0; 0 0 -1; 1 1 1], [0 -1 0; 0 0 1; -1 -1 -1], 
    [0 1 0; 0 0 -1; -1 -1 -1], [0 -1 0; 1 1 1; 0 0 1], [0 1 0; -1 -1 -1; 0 0 1], 
    [0 1 0; 1 1 1; 0 0 -1], [0 -1 0; -1 -1 -1; 0 0 -1], [0 0 -1; 0 1 0; 1 1 1], 
    [0 0 1; 0 -1 0; 1 1 1], [0 0 1; 0 1 0; -1 -1 -1], [0 0 -1; 0 -1 0; -1 -1 -1], 
    [0 0 1; 1 1 1; 0 1 0], [0 0 -1; -1 -1 -1; 0 1 0], [0 0 -1; 1 1 1; 0 -1 0], 
    [0 0 1; -1 -1 -1; 0 -1 0], [1 1 1; 0 1 0; 0 0 1], [-1 -1 -1; 0 -1 0; 0 0 1], 
    [-1 -1 -1; 0 1 0; 0 0 -1], [1 1 1; 0 -1 0; 0 0 -1], [-1 -1 -1; 0 0 1; 0 1 0], 
    [1 1 1; 0 0 -1; 0 1 0], [1 1 1; 0 0 1; 0 -1 0], [-1 -1 -1; 0 0 -1; 0 -1 0]
]
d322_array = [
    [-1 0 0; 0 0 1; 1 1 1], [1 0 0; 0 0 -1; 1 1 1], [1 0 0; 0 0 1; -1 -1 -1], 
    [-1 0 0; 0 0 -1; -1 -1 -1], [1 0 0; 1 1 1; 0 0 1], [-1 0 0; -1 -1 -1; 0 0 1], 
    [-1 0 0; 1 1 1; 0 0 -1], [1 0 0; -1 -1 -1; 0 0 -1], [0 0 1; 1 0 0; 1 1 1], 
    [0 0 -1; -1 0 0; 1 1 1], [0 0 -1; 1 0 0; -1 -1 -1], [0 0 1; -1 0 0; -1 -1 -1], 
    [0 0 -1; 1 1 1; 1 0 0], [0 0 1; -1 -1 -1; 1 0 0], [0 0 1; 1 1 1; -1 0 0], 
    [0 0 -1; -1 -1 -1; -1 0 0], [-1 -1 -1; 1 0 0; 0 0 1], [1 1 1; -1 0 0; 0 0 1], 
    [1 1 1; 1 0 0; 0 0 -1], [-1 -1 -1; -1 0 0; 0 0 -1], [1 1 1; 0 0 1; 1 0 0], 
    [-1 -1 -1; 0 0 -1; 1 0 0], [-1 -1 -1; 0 0 1; -1 0 0], [1 1 1; 0 0 -1; -1 0 0]
]
d323_array = [
    [1 0 0; 0 1 0; 1 1 1], [-1 0 0; 0 -1 0; 1 1 1], [-1 0 0; 0 1 0; -1 -1 -1], 
    [1 0 0; 0 -1 0; -1 -1 -1], [-1 0 0; 1 1 1; 0 1 0], [1 0 0; -1 -1 -1; 0 1 0], 
    [1 0 0; 1 1 1; 0 -1 0], [-1 0 0; -1 -1 -1; 0 -1 0], [0 -1 0; 1 0 0; 1 1 1], 
    [0 1 0; -1 0 0; 1 1 1], [0 1 0; 1 0 0; -1 -1 -1], [0 -1 0; -1 0 0; -1 -1 -1], 
    [0 1 0; 1 1 1; 1 0 0], [0 -1 0; -1 -1 -1; 1 0 0], [0 -1 0; 1 1 1; -1 0 0], 
    [0 1 0; -1 -1 -1; -1 0 0], [1 1 1; 1 0 0; 0 1 0], [-1 -1 -1; -1 0 0; 0 1 0], 
    [-1 -1 -1; 1 0 0; 0 -1 0], [1 1 1; -1 0 0; 0 -1 0], [-1 -1 -1; 0 1 0; 1 0 0], 
    [1 1 1; 0 -1 0; 1 0 0], [1 1 1; 0 1 0; -1 0 0], [-1 -1 -1; 0 -1 0; -1 0 0]
]
d324_array = [
    [1 0 0; 0 1 0; 0 0 1], [-1 0 0; 0 -1 0; 0 0 1], [-1 0 0; 0 1 0; 0 0 -1], 
    [1 0 0; 0 -1 0; 0 0 -1], [-1 0 0; 0 0 1; 0 1 0], [1 0 0; 0 0 -1; 0 1 0], 
    [1 0 0; 0 0 1; 0 -1 0], [-1 0 0; 0 0 -1; 0 -1 0], [0 -1 0; 1 0 0; 0 0 1], 
    [0 1 0; -1 0 0; 0 0 1], [0 1 0; 1 0 0; 0 0 -1], [0 -1 0; -1 0 0; 0 0 -1], 
    [0 1 0; 0 0 1; 1 0 0], [0 -1 0; 0 0 -1; 1 0 0], [0 -1 0; 0 0 1; -1 0 0], 
    [0 1 0; 0 0 -1; -1 0 0], [0 0 1; 1 0 0; 0 1 0], [0 0 -1; -1 0 0; 0 1 0], 
    [0 0 -1; 1 0 0; 0 -1 0], [0 0 1; -1 0 0; 0 -1 0], [0 0 -1; 0 1 0; 1 0 0], 
    [0 0 1; 0 -1 0; 1 0 0], [0 0 1; 0 1 0; -1 0 0], [0 0 -1; 0 -1 0; -1 0 0]
]
d411_array = [
    [1 0 0; 0 0 1; -1 -1 0], [-1 0 0; 0 0 -1; -1 -1 0], [-1 0 0; 1 0 1; 1 1 0], 
    [1 0 0; -1 0 -1; 1 1 0], [0 0 1; 1 0 0; 1 1 0], [0 0 -1; -1 0 0; 1 1 0], 
    [0 0 -1; 1 0 1; -1 -1 0], [0 0 1; -1 0 -1; -1 -1 0], [-1 0 -1; 1 0 0; -1 -1 0], 
    [1 0 1; -1 0 0; -1 -1 0], [-1 0 -1; 0 0 1; 1 1 0], [1 0 1; 0 0 -1; 1 1 0]
]
d412_array = [
    [1 0 0; 0 1 0; 1 0 1], [-1 0 0; 0 -1 0; 1 0 1], [-1 0 0; 1 1 0; -1 0 -1], 
    [1 0 0; -1 -1 0; -1 0 -1], [0 1 0; 1 0 0; -1 0 -1], [0 -1 0; -1 0 0; -1 0 -1], 
    [0 -1 0; 1 1 0; 1 0 1], [0 1 0; -1 -1 0; 1 0 1], [-1 -1 0; 1 0 0; 1 0 1], 
    [1 1 0; -1 0 0; 1 0 1], [-1 -1 0; 0 1 0; -1 0 -1], [1 1 0; 0 -1 0; -1 0 -1]
]
d413_array = [
    [1 0 0; 0 0 1; 0 -1 0], [-1 0 0; 0 0 -1; 0 -1 0], [-1 0 0; 1 0 1; 0 1 0], 
    [1 0 0; -1 0 -1; 0 1 0], [0 0 1; 1 0 0; 0 1 0], [0 0 -1; -1 0 0; 0 1 0], 
    [0 0 -1; 1 0 1; 0 -1 0], [0 0 1; -1 0 -1; 0 -1 0], [-1 0 -1; 1 0 0; 0 -1 0], 
    [1 0 1; -1 0 0; 0 -1 0], [-1 0 -1; 0 0 1; 0 1 0], [1 0 1; 0 0 -1; 0 1 0]
]
d414_array = [
    [1 0 0; 0 1 0; 0 0 1], [-1 0 0; 0 -1 0; 0 0 1], [-1 0 0; 1 1 0; 0 0 -1], 
    [1 0 0; -1 -1 0; 0 0 -1], [0 1 0; 1 0 0; 0 0 -1], [0 -1 0; -1 0 0; 0 0 -1], 
    [0 -1 0; 1 1 0; 0 0 1], [0 1 0; -1 -1 0; 0 0 1], [-1 -1 0; 1 0 0; 0 0 1], 
    [1 1 0; -1 0 0; 0 0 1], [-1 -1 0; 0 1 0; 0 0 -1], [1 1 0; 0 -1 0; 0 0 -1]
]
d42_array = [
    [0 1 0; 0 0 -1; -1 -1 0], [0 -1 0; 0 0 1; -1 0 -1], [0 -1 0; 1 1 0; 0 0 1], 
    [0 1 0; -1 -1 0; 1 0 1], [0 1 0; 1 0 1; 0 0 -1], [0 -1 0; -1 0 -1; 1 1 0], 
    [0 0 1; 0 -1 0; 1 1 0], [0 0 -1; 0 1 0; 1 0 1], [0 0 -1; -1 -1 0; 0 1 0], 
    [0 0 1; 1 1 0; -1 0 -1], [0 0 1; -1 0 -1; 0 -1 0], [0 0 -1; 1 0 1; -1 -1 0], 
    [-1 -1 0; 0 1 0; 0 0 -1], [1 1 0; 0 -1 0; -1 0 -1], [1 1 0; 0 0 1; 0 -1 0], 
    [-1 -1 0; 0 0 -1; 1 0 1], [-1 -1 0; 1 0 1; 0 1 0], [1 1 0; -1 0 -1; 0 0 1], 
    [-1 0 -1; 0 -1 0; 0 0 1], [1 0 1; 0 1 0; -1 -1 0], [1 0 1; 0 0 -1; 0 1 0], 
    [-1 0 -1; 0 0 1; 1 1 0], [-1 0 -1; 1 1 0; 0 -1 0], [1 0 1; -1 -1 0; 0 0 -1]
]
d311 = [gelt_from_matrix(M,temp_basis) for M in d311_array]
d312 = [gelt_from_matrix(M,temp_basis) for M in d312_array]
d313 = [gelt_from_matrix(M,temp_basis) for M in d313_array]
d321 = [gelt_from_matrix(M,temp_basis) for M in d321_array]
d322 = [gelt_from_matrix(M,temp_basis) for M in d322_array]
d323 = [gelt_from_matrix(M,temp_basis) for M in d323_array]
d324 = [gelt_from_matrix(M,temp_basis) for M in d324_array]
d411 = [gelt_from_matrix(M,temp_basis) for M in d411_array]
d412 = [gelt_from_matrix(M,temp_basis) for M in d412_array]
d413 = [gelt_from_matrix(M,temp_basis) for M in d413_array]
d414 = [gelt_from_matrix(M,temp_basis) for M in d414_array]
d42 = [gelt_from_matrix(M,temp_basis) for M in d42_array]

half_basis_sat = unique(union(d311, d312, d313, d321, d322, d323, d324, d411, d412, d413, d414, d42))
half_basis_sat = unique([half_basis_sat;inv.(half_basis_sat)])
RG = LowCohomologySOS.group_ring(sl3, half_basis_sat, star_multiplication = false)

d3₁ = rg_elt([
    (1,averaged_rep(d311_array, half_basis_sat, RG)),
    (-1,averaged_rep(d312_array, half_basis_sat, RG)),
    (-1,averaged_rep(d313_array, half_basis_sat, RG))
])
d3₂ = rg_elt([
    (1,averaged_rep(d321_array, half_basis_sat, RG)),
    (-1,averaged_rep(d322_array, half_basis_sat, RG)),
    (1,averaged_rep(d323_array, half_basis_sat, RG)),
    (-1,averaged_rep(d324_array, half_basis_sat, RG))
])
d4₁ = rg_elt([
    (-1,averaged_rep(d411_array, half_basis_sat, RG)),
    (1,averaged_rep(d412_array, half_basis_sat, RG)),
    (-1,averaged_rep(d413_array, half_basis_sat, RG)),
    (1,averaged_rep(d414_array, half_basis_sat, RG))
])
d4₂ = rg_elt([
    (1,averaged_rep(d42_array, half_basis_sat, RG))
])

d₃ = [d3₁ d3₂]
d₄ = [
    d4₁;
    d4₂
]
m31_stab_part = one(RG)-averaged_rep(m31_arrays, half_basis_sat, RG)
m32_stab_part = one(RG)-averaged_rep(m32_arrays, half_basis_sat, RG)
stab_part = [
    m31_stab_part zero(RG);
    zero(RG) m32_stab_part
]
Δ₃x = d₃'*d₃+d₄*d₄'+stab_part
RG_star = LowCohomologySOS.group_ring(sl3, half_basis_sat, star_multiplication = true)
Δ₃ = LowCohomologySOS.embed.(identity, Δ₃x, Ref(RG_star))
I = [
    one(RG_star) zero(RG_star);
    zero(RG_star) one(RG_star)
]

sos_problem = LowCohomologySOS.sos_problem(Δ₃, I, 0.05)

JuMP.set_optimizer(sos_problem, scs_opt(eps = 1e-9, max_iters = 500))
JuMP.optimize!(sos_problem)
λ, Q = LowCohomologySOS.get_solution(sos_problem)
LowCohomologySOS.certify_sos_decomposition(Δ₃, I, λ, Q, half_basis_sat)

sl3_voronoi_data = (
    M = Δ₃,
    order_unit = I,
    half_basis = half_basis_sat
)
solve_in_loop(
    sos_problem,
    logdir = joinpath(@__DIR__, "logs_voronoi_delta_3"),
    optimizer = scs_opt(eps = 1e-9, max_iters = 20_000),
    data = sl3_voronoi_data
)